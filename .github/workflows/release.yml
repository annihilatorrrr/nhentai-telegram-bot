name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-attach:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: package.json

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build
        run: bun run build

      - name: Package source
        run: |
          archive="nhentai-telegram-bot-${GITHUB_REF_NAME}-source.tar.gz"
          git archive --format=tar.gz --output "$archive" "$GITHUB_SHA"

      - name: Package build output
        run: |
          archive="nhentai-telegram-bot-${GITHUB_REF_NAME}-built.tar.gz"
          tar -czf "$archive" built

      - name: Upload workflow artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ github.ref_name }}
          path: |
            nhentai-telegram-bot-${{ github.ref_name }}-source.tar.gz
            nhentai-telegram-bot-${{ github.ref_name }}-built.tar.gz

      - name: Upload release assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          tag="$GITHUB_REF_NAME"
          source="nhentai-telegram-bot-${tag}-source.tar.gz"
          built="nhentai-telegram-bot-${tag}-built.tar.gz"

          # Check if release already exists (created via UI)
          if gh release view "$tag" > /dev/null 2>&1; then
            # Upload assets to existing release
            gh release upload "$tag" "$source" "$built" --clobber
          else
            # Create new release with assets
            gh release create "$tag" \
              --title="$tag" \
              --generate-notes \
              "$source" "$built"
          fi
